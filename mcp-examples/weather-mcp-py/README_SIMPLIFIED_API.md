# Weather MCP Server - Simplified API üöÄ

## üéØ Dos Implementaciones Disponibles

Este proyecto incluye **dos implementaciones** del Weather MCP Server:

### 1Ô∏è‚É£ `app.py` - **Advanced API** (Implementaci√≥n Original)

- ‚úÖ Control de bajo nivel
- ‚úÖ Usa `payments.mcp.configure()` + `payments.mcp.with_paywall()`
- ‚úÖ Integraci√≥n manual con FastMCP o servidor custom
- ‚úÖ Mayor flexibilidad y control

**Cu√°ndo usar:** Cuando necesitas control detallado o integraci√≥n con frameworks espec√≠ficos.

### 2Ô∏è‚É£ `server.py` - **Simplified API** (Nueva - Recomendada) ‚≠ê

- ‚úÖ **3 l√≠neas de c√≥digo** para servidor completo
- ‚úÖ Usa `payments.mcp.registerTool()` + `payments.mcp.start()`
- ‚úÖ **OAuth 2.1 autom√°tico** (RFC 8414, 9728, 7591, OIDC)
- ‚úÖ **Session management autom√°tico** (SSE)
- ‚úÖ **FastAPI app autom√°tica**
- ‚úÖ **Paywall autom√°tico**

**Cu√°ndo usar:** Para la mayor√≠a de casos. Menos c√≥digo, misma funcionalidad.

---

## üöÄ Quick Start - Simplified API

### 1. Configurar Variables de Entorno

Crea un archivo `.env`:

```bash
# Nevermined Credentials
NVM_SERVER_API_KEY=your-api-key-here
NVM_AGENT_ID=did:nv:your-agent-id
NVM_ENV=staging_sandbox

# Server Configuration
PORT=5001

# Optional: OpenAI for enhanced forecasts
OPENAI_API_KEY=your-openai-key
```

### 2. Instalar Dependencias

```bash
pip install -r requirements.txt
```

### 3. Ejecutar Servidor (Simplified API)

```bash
python src/server.py
```

**Salida esperada:**

```
üöÄ Weather MCP Server with Nevermined Integration Started!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üì° MCP Endpoint:     http://localhost:5001/mcp
üè• Health Check:     http://localhost:5001/health
‚ÑπÔ∏è  Server Info:      http://localhost:5001/

üîê OAuth Endpoints (auto-generated by Nevermined):
   ‚îú‚îÄ Discovery:     http://localhost:5001/.well-known/oauth-authorization-server
   ‚îú‚îÄ Protected:     http://localhost:5001/.well-known/oauth-protected-resource
   ‚îú‚îÄ OIDC Config:   http://localhost:5001/.well-known/openid-configuration
   ‚îî‚îÄ Registration:  http://localhost:5001/register

üõ†Ô∏è  Tools: weather.today (dynamic credits)
üì¶ Resources: weather://today/{city} (5 credits)
üí¨ Prompts: weather.ensureCity (1 credit)
üåç Environment: staging_sandbox
üÜî Agent ID: did:nv:abc123

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
```

### 4. Probar el Servidor

**Health Check:**

```bash
curl http://localhost:5001/health
```

**Server Info (incluye configuraci√≥n OAuth):**

```bash
curl http://localhost:5001/
```

**OAuth Discovery:**

```bash
curl http://localhost:5001/.well-known/oauth-authorization-server
```

---

## üìù Comparaci√≥n de C√≥digo

### Advanced API (`app.py`)

```python
# 1. Configurar payments
payments.mcp.configure({
    "agentId": agent_id,
    "serverName": server_name,
    "getContext": fastmcp.get_context
})

# 2. Proteger handlers manualmente
protected_tool = payments.mcp.with_paywall(
    weather_tool_handler,
    {"kind": "tool", "name": "weather.today", "credits": calculator}
)

# 3. Registrar en FastMCP manualmente
@fastmcp.tool(name="weather.today", title="Today's Weather")
async def _tool(city: str | None = None) -> str:
    args = {"city": city or ""}
    res = await protected_tool(args)
    # ... m√°s c√≥digo para transformar respuesta ...
    return result

# 4. Crear app FastAPI manualmente
app = FastAPI(lifespan=_lifespan)
app.mount("/", sub_app)

# 5. Ejecutar con uvicorn
uvicorn.run(app, host="0.0.0.0", port=5001)
```

**Total:** ~200 l√≠neas de c√≥digo boilerplate

---

### Simplified API (`server.py`) ‚≠ê

```python
# 1. Registrar tool (paywall autom√°tico)
payments.mcp.registerTool(
    "weather.today",
    {
        "title": "Today's Weather",
        "description": "Get today's weather summary for a city",
        "inputSchema": WeatherToolInput.model_json_schema(),
    },
    weather_tool_handler,
    {"credits": weather_tool_credits_calculator}
)

# 2. Iniciar servidor completo (OAuth autom√°tico)
result = await payments.mcp.start({
    "port": 5001,
    "agentId": NVM_AGENT_ID,
    "serverName": "weather-mcp",
    "version": "0.1.0"
})

# 3. Detener cuando sea necesario
await result["stop"]()
```

**Total:** ~15 l√≠neas de c√≥digo (93% menos c√≥digo)

---

## üé® Caracter√≠sticas Autom√°ticas de Simplified API

Cuando usas `payments.mcp.start()`, autom√°ticamente obtienes:

### ‚úÖ OAuth 2.1 Completo

- **RFC 8414** - Authorization Server Metadata
- **RFC 9728** - Protected Resource Metadata
- **RFC 7591** - Dynamic Client Registration
- **OpenID Connect Discovery**

### ‚úÖ Endpoints HTTP

| Endpoint                                                | Descripci√≥n                       |
| ------------------------------------------------------- | --------------------------------- |
| `POST /mcp`                                             | Procesar requests MCP (JSON-RPC)  |
| `GET /mcp`                                              | Stream SSE para sesiones          |
| `DELETE /mcp`                                           | Terminar sesi√≥n                   |
| `GET /`                                                 | Server info con OAuth config      |
| `GET /health`                                           | Health check                      |
| `GET /.well-known/oauth-authorization-server`           | OAuth AS metadata                 |
| `GET /.well-known/oauth-protected-resource`             | Protected resource metadata       |
| `GET /.well-known/openid-configuration`                 | OIDC configuration                |
| `POST /register`                                        | Dynamic client registration       |

### ‚úÖ Features de Producci√≥n

- ‚úÖ **CORS** - Configurado autom√°ticamente
- ‚úÖ **Paywall** - Todos los handlers protegidos
- ‚úÖ **Session Management** - SSE sessions autom√°ticas
- ‚úÖ **Error Handling** - Manejo robusto de errores
- ‚úÖ **Logging** - Sistema de logging opcional
- ‚úÖ **Graceful Shutdown** - Cierre limpio de conexiones

---

## üîß Handlers Reutilizables

Ambas implementaciones (`app.py` y `server.py`) usan los **mismos handlers**:

```
src/local_mcp/handlers/
‚îú‚îÄ‚îÄ weather_tool.py           # weather.today tool
‚îú‚îÄ‚îÄ weather_resource.py       # weather://today/{city} resource
‚îî‚îÄ‚îÄ weather_prompt.py         # weather.ensureCity prompt
```

Estos handlers son compatibles con **ambas APIs**:

- ‚úÖ Reciben `args` dict
- ‚úÖ Reciben opcional `context` (para Advanced API) o `_extra` (ignorado en Simplified)
- ‚úÖ Retornan formatos est√°ndar MCP

---

## üìä Cr√©ditos

### Tool: `weather.today`

- **Cr√©ditos:** Din√°micos (5-14)
- **C√°lculo:** Basado en respuesta (ver `weather_tool_credits_calculator`)

### Resource: `weather://today/{city}`

- **Cr√©ditos:** Fijos (5)

### Prompt: `weather.ensureCity`

- **Cr√©ditos:** Fijos (1)

---

## üß™ Testing

### Con MCP Inspector (Recomendado)

```bash
# Iniciar servidor
python src/server.py

# En otra terminal, usar MCP Inspector
npx @modelcontextprotocol/inspector http://localhost:5001/mcp
```

### Con curl

**1. Inicializar sesi√≥n:**

```bash
curl -X POST http://localhost:5001/mcp \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "initialize",
    "params": {
      "protocolVersion": "2024-11-05",
      "capabilities": {},
      "clientInfo": {"name": "test", "version": "1.0.0"}
    }
  }'
```

**2. Listar tools:**

```bash
curl -X POST http://localhost:5001/mcp \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "mcp-session-id: SESSION_ID" \
  -d '{
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/list"
  }'
```

**3. Llamar tool:**

```bash
curl -X POST http://localhost:5001/mcp \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "mcp-session-id: SESSION_ID" \
  -d '{
    "jsonrpc": "2.0",
    "id": 3,
    "method": "tools/call",
    "params": {
      "name": "weather.today",
      "arguments": {"city": "London"}
    }
  }'
```

---

## üêõ Troubleshooting

### Error: "NVM_SERVER_API_KEY environment variable is required"

**Soluci√≥n:** Crea archivo `.env` con tus credenciales.

### Error: "ModuleNotFoundError: No module named 'mcp'"

**Soluci√≥n:**

```bash
pip install modelcontextprotocol
```

### Error: "Port 5001 already in use"

**Soluci√≥n:** Cambia el puerto en `.env`:

```bash
PORT=5002
```

### OAuth endpoints no funcionan

**Soluci√≥n:** Verifica que `enableOAuthDiscovery=True` (por defecto est√° habilitado).

---

## üìö Documentaci√≥n Adicional

- [Nevermined Docs](https://docs.nevermined.app)
- [MCP Protocol](https://modelcontextprotocol.io)
- [payments-py GitHub](https://github.com/nevermined-io/payments-py)

---

## üÜö Cu√°ndo Usar Cada API

### Usa Simplified API (`server.py`) si:

- ‚úÖ Quieres empezar r√°pido
- ‚úÖ No necesitas control de bajo nivel
- ‚úÖ Quieres OAuth autom√°tico
- ‚úÖ Quieres menos c√≥digo
- ‚úÖ Es tu primer servidor MCP

### Usa Advanced API (`app.py`) si:

- ‚úÖ Necesitas integraci√≥n con framework espec√≠fico
- ‚úÖ Quieres control total del servidor
- ‚úÖ Tienes requisitos customizados
- ‚úÖ Necesitas modificar el flujo de autenticaci√≥n

---

## üéâ Resumen

**Simplified API = Advanced API - Boilerplate**

| Feature                | Advanced API | Simplified API |
| ---------------------- | ------------ | -------------- |
| C√≥digo necesario       | ~200 l√≠neas  | ~15 l√≠neas     |
| OAuth autom√°tico       | ‚ùå           | ‚úÖ             |
| Session management     | Manual       | Autom√°tico     |
| FastAPI setup          | Manual       | Autom√°tico     |
| Paywall protection     | ‚úÖ           | ‚úÖ             |
| Control de bajo nivel  | ‚úÖ           | ‚ùå             |
| Recomendado para       | Casos custom | Mayor√≠a casos  |

**Recomendaci√≥n:** Usa `server.py` (Simplified API) a menos que necesites control espec√≠fico.



